<html>
<head>
<title>Games</title>
<script src=js/libs/zepto.js></script>
</head>
<body>
	Game List
	
	<div id="gameList"></div>
	<p/>
	<a href="#" onClick="createGame('first')">Create Game</a>
	
	<p/>
	<div id="messages"></div>
	<div id="currentGame"></div>
</body>
<script>
	newGameLine = function(game) {
		return "<li id='"+game.name+"' class='"+ game.status + "'>" + game.name
				+ " (" + game.status + ") <a href=# onCLick='joinGame(\"" + game.name.toString()
				+ "\")'>join game</a></li>";
	};

	register = function() {
		var location = "ws://" + document.location.host + "/gameMessage";
		_ws = new WebSocket(location, "game");
		_ws.onmessage = function(message) {
			jsonMsg = JSON.parse(message.data);
			if (jsonMsg.updatedGame){
				$("#" + jsonMsg.updatedGame.name).remove();
				$("#gameList").append(newGameLine(jsonMsg.updatedGame));
			}
			if (jsonMsg.yourTurn){
				$("#currentGame").addClass("STARTED");
				$("#messages").append("<li>" + jsonMsg.board + "</li>");
			}
			if (jsonMsg.message){
				$("#messages").append("<li>" + jsonMsg.message + "</li>");
			}
		};
		return _ws;
	};

	joinGame = function(gameId) {
		ws.send("join " + gameId);
	}

	createGame = function(gameId) {
		ws.send("create " + gameId);
	};
	
	listGames = function(){
		$.getJSON("/game/list", function(json) {
			$("#gameList").empty();
			json.forEach(function(game) {
				$("#gameList").append(newGameLine(game));
			});
		});		
	};
	
	Zepto(function($) {
		ws = register();
		listGames();
	})
</script>
</html>